<script>
  document.getElementById("submitButton").addEventListener("click", function() {
    const userResponse = document.getElementById("responseBox").value;

    // Retrieve the assigned condition from sessionStorage
    const assignedCondition = sessionStorage.getItem("assignedCondition");
    
    // If the condition is null, log an error
    if (!assignedCondition) {
      console.error("Condition is not set in sessionStorage!");
      alert("Error: Condition not set.");
      return;
    }

    // Prepare data for sending
    const data = {
      condition: assignedCondition, // condition from sessionStorage
      response: userResponse,       // user input response
      timestamp: Date.now()          // timestamp of the submission
    };

    // Log data to check format
    console.log("Data being sent:", data);

    // Send data to the jsPsych API
    fetch("https://pipe.jspsych.org/api/data/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "*/*",
      },
      body: JSON.stringify({
        experimentID: "vMOMMZm8ucfh",  // Your experiment ID
        filename: `farm_response_${Date.now()}.csv`,  // Unique filename
        data: data  // Send data as a plain object
      }),
    })
    .then(response => response.json())
    .then(data => {
      console.log("Data sent successfully:", data);
      // Thank you message
      document.getElementById("container").innerHTML = `
        <h2>Thank you for your participation!</h2>
        <p>Please close this window.</p>
      `;
    })
    .catch(error => {
      console.error("Error sending data:", error);
      // Display error message
      document.getElementById("container").innerHTML = `
        <h2>Sorry, there was an error submitting your response.</h2>
        <p>Please try again later.</p>
      `;
    });
  });
</script>
